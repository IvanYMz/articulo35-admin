---
import Layout from "../layouts/Layout.astro";
import { supabase } from "../lib/supabase";

type Student = {
    id: number;
    student_id: number;
    name: string;
    subjects: string[];
};

const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
  return Astro.redirect("/signin");
}

let session;
try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });
  if (session.error) {
    Astro.cookies.delete("sb-access-token", {
      path: "/",
    });
    Astro.cookies.delete("sb-refresh-token", {
      path: "/",
    });
    return Astro.redirect("/signin");
  }
} catch (error) {
  Astro.cookies.delete("sb-access-token", {
    path: "/",
  });
  Astro.cookies.delete("sb-refresh-token", {
    path: "/",
  });
  return Astro.redirect("/signin");
}

console.log(session);

// Fetch data
let students: Student[] = [];
try {
    const response = await fetch("http://localhost:4321/api/students_info/requests");
    if (!response.ok) {
        console.error("Error fetching academic records");
    } else {
        students = (await response.json()) as Student[];
    }
} catch (err) {
    console.error("Fetch error:", err);
}

---

<Layout title="Home">
    <section>
        <h2>Peticiones de oportunidad para Art√≠culo 35</h2>
        {
            students.length > 0 ? (
                <ul>
                    {students.map((student) => (
                        <li>
                            <strong>{student.name}</strong>
                            <ul>
                                {student.subjects.map((subject) => (
                                    <li>{subject}</li>
                                ))}
                            </ul>
                            <a href={`/students/${student.student_id}`}>Detalles</a>
                        </li>
                    ))}
                </ul>
            ) : (
                <p>No student records available.</p>
            )
        }
    </section>
</Layout>
